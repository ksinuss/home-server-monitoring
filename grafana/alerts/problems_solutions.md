# Проблемы и решения при настройке алертов в Grafana

## 1. Ошибка "function now not defined"
Ошибка при использовании функции now() в шаблонах

### Решение
Используйте встроенные переменные времени алерта вместо функции now():
```jinja2
# Неправильно:
{{ now() }}

# Правильно:
{{ .StartsAt.Format "15:04 | 02 Jan" }}
```

---

## 2. Ошибки отправки в Telegram (400 Bad Request)
Ошибка: "400 Bad Request" от API Telegram

### Решение
1. Упростите форматирование сообщения:
- Уберите сложное Markdown-форматирование
- Используйте простой текст с базовыми эмодзи
2. Проверьте корректность Chat ID (должен быть отрицательным числом для групп)
3. Убедитесь, что бот добавлен в группу и имеет права на отправку сообщений

---

## 3. Расхождение метрик с системными утилитами
Метрики диска в Grafana показывают 85%, а df -h показывает 90%

### Решение
Учтите резервные блоки root (обычно 5%):
```promql
expr: (node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_avail_bytes{mountpoint="/"}) / node_filesystem_size_bytes{mountpoint="/"} * 100 > 85
```

---

## 4. Низкие значения сетевых метрик
Скорость сети показывает 8 МБ/с вместо ожидаемых 100 Мбит/с

### Решение
1. Проверьте преобразование единиц измерения:
```promql
# Правильный запрос для Мбит/с:
rate(node_network_receive_bytes_total{device="eth0"}[1m]) * 8 / 1000000
```

2. Убедитесь в правильности интерфейса:
```bash
# Проверьте имя интерфейса:
ip link show
curl -s http://localhost:9100/metrics | grep network
```

---

## 5. Проблемы с тестированием алертов
Сложно протестировать алерты без реальных проблем

### Решение
Создавайте контролируемые условия:
```bash
# Для тестирования CPU:
stress-ng --cpu 2 --timeout 30s

# Для тестирования диска:
sudo fallocate -l 1G /test_file.bin

# Для тестирования памяти:
stress-ng --vm 1 --vm-bytes 500M --timeout 30s
```

---

## Полезные команды для диагностики
```bash
# Проверка метрик Node Exporter
curl http://localhost:9100/metrics | grep -E "(cpu|memory|disk|network)"

# Проверка логов Grafana
journalctl -u grafana-server -f
```
